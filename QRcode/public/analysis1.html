<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>溯源码数据分析平台</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://webapi.amap.com/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- 导出PDF所需库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .map-container {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
        }

        .chart-container {
            height: 350px;
            border-radius: 8px;
            overflow: hidden;
        }

        .dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }

        .light-mode {
            background-color: #f0f8f0;
            color: #2d3748;
            background-image: linear-gradient(rgba(144, 238, 144, 0.1) 1px, transparent 1px),
                            linear-gradient(90deg, rgba(144, 238, 144, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .dark-card {
            background-color: #2d3748;
            border: 1px solid #4a5568;
        }

        .light-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .dark-table {
            background-color: #2d3748;
            color: #e2e8f0;
        }

        .dark-table th {
            border-color: #4a5568;
        }

        .dark-table td {
            border-color: #4a5568;
        }

        .light-table {
            background-color: #ffffff;
            color: #2d3748;
        }

        .light-table th {
            border-color: #e2e8f0;
            background-color: #f9fafb;
        }

        .light-table td {
            border-color: #e2e8f0;
        }

        .form-input:focus {
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.2);
            transition: all 0.3s ease;
        }

        .form-input {
            transition: all 0.3s ease;
        }

        .product-detail-modal {
            max-width: 90%;
            max-height: 85vh;
        }

        .product-detail-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1rem;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .map-container {
                height: 400px;
            }

            .chart-container {
                height: 300px;
            }

            .product-detail-modal {
                max-width: 95%;
                max-height: 90vh;
            }

            .product-detail-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-50 light-mode">
    <div id="app">
        <!-- 导航栏 -->
        <nav class="bg-white shadow-md p-4 sticky top-0 z-50 w-full dark:bg-gray-800">
            <div class="container mx-auto flex flex-wrap justify-between items-center">
                <div class="flex items-center">
                    <span class="text-xl font-bold text-green-700 dark:text-green-400">智慧农场溯源系统 - 数据分析</span>
                </div>
                <div class="flex space-x-2 md:space-x-4 text-sm md:text-base">
                    <button @click="toggleDarkMode" class="text-green-600 hover:text-green-800 px-2 py-1 dark:text-green-400 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path v-if="darkMode" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            <path v-else stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                        <span v-if="!darkMode">暗色模式</span>
                        <span v-else>亮色模式</span>
                    </button>
                    <a href="index.html" class="text-green-600 hover:text-green-800 px-2 py-1 dark:text-green-400 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        返回主界面
                    </a>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-8">
            <!-- 筛选条件 - 优化后的设计 -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 light-card dark:dark-card">
                <h2 class="text-2xl font-bold text-green-700 dark:text-green-400 mb-4">数据筛选</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="flex flex-col space-y-2">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">产品名称</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <input v-model="filters.productName" type="text" class="form-input border pl-10 p-2 rounded-md focus:outline-none w-full dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="输入产品名称关键字">
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">生产日期范围</label>
                        <div class="flex space-x-2">
                            <input v-model="filters.startDate" type="date" class="form-input border p-2 rounded-l-md flex-1 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <input v-model="filters.endDate" type="date" class="form-input border p-2 rounded-r-md flex-1 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">生产地区</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            <input v-model="filters.region" type="text" class="form-input border pl-10 p-2 rounded-md focus:outline-none w-full dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="输入地区关键字">
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">产品类型</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                            </div>
                            <select v-model="filters.productType" class="form-input border pl-10 p-2 rounded-md focus:outline-none w-full dark:bg-gray-700 dark:border-gray-600 dark:text-white appearance-none">
                                <option value="">全部类型</option>
                                <option v-for="(count, type) in productTypeCounts" :value="type">{{ type }} ({{ count }})</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-4">
                    <button @click="resetFilters" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors duration-300 mr-2 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        重置筛选
                    </button>
                    <button @click="applyFilters" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors duration-300 dark:bg-green-700 dark:hover:bg-green-800 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        应用筛选
                    </button>
                </div>
            </div>
            <button @click="exportPDF" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors duration-300 dark:bg-blue-700 dark:hover:bg-blue-800 flex items-center mb-6">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v10a2 2 0 002 2h10M8 7H6m8 4l-4-4M6 17h.01"></path>
                </svg>
                导出PDF报表
            </button>
            <!-- 数据概览 - 优化后的设计 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 text-center light-card dark:dark-card transition-all duration-300 hover:shadow-lg">
                    <div class="flex items-center justify-center mb-2 text-green-600 dark:text-green-400">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-green-700 dark:text-green-400 mb-1">总产品数</h3>
                    <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">{{ totalProducts }}</p>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 text-center light-card dark:dark-card transition-all duration-300 hover:shadow-lg">
                    <div class="flex items-center justify-center mb-2 text-blue-600 dark:text-blue-400">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-green-700 dark:text-green-400 mb-1">本月新增</h3>
                    <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">{{ thisMonthProducts }}</p>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 text-center light-card dark:dark-card transition-all duration-300 hover:shadow-lg">
                    <div class="flex items-center justify-center mb-2 text-green-600 dark:text-green-400">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-green-700 dark:text-green-400 mb-1">有机认证</h3>
                    <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">{{ organicProducts }}</p>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 text-center light-card dark:dark-card transition-all duration-300 hover:shadow-lg">
                    <div class="flex items-center justify-center mb-2 text-yellow-600 dark:text-yellow-400">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-green-700 dark:text-green-400 mb-1">今日活跃</h3>
                    <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">{{ activeToday }}</p>
                </div>
            </div>

            <!-- 图表区域 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <!-- 产品类型分布 -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 dark-card">
                    <h3 class="text-xl font-bold text-green-700 dark:text-green-400 mb-4">产品类型分布</h3>
                    <div class="chart-container" id="productTypeChart"></div>
                </div>

                <!-- 产品数量趋势 -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 dark-card">
                    <h3 class="text-xl font-bold text-green-700 dark:text-green-400 mb-4">产品数量趋势</h3>
                    <div class="chart-container" id="productTrendChart"></div>
                </div>

                <!-- 地区分布 -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 dark-card">
                    <h3 class="text-xl font-bold text-green-700 dark:text-green-400 mb-4">地区分布</h3>
                    <div class="chart-container" id="regionDistributionChart"></div>
                </div>

                <!-- 营养成分分析 -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 dark-card">
                    <h3 class="text-xl font-bold text-green-700 dark:text-green-400 mb-4">营养成分分析</h3>
                    <div class="chart-container" id="nutritionChart"></div>
                </div>
            </div>

            <!-- 地图展示 -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-8 dark-card">
                <h3 class="text-xl font-bold text-green-700 dark:text-green-400 mb-4">产品地理位置分布</h3>
                <div id="mapContainer" class="map-container"></div>
            </div>

            <!-- 数据表格 -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-xl font-bold text-green-700 dark:text-green-400 mb-4">产品数据列表</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 dark-table">
                        <thead>
                            <tr>
                                <th scope="col" class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    产品名称
                                </th>
                                <th scope="col" class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    产品类型
                                </th>
                                <th scope="col" class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    生产地区
                                </th>
                                <th scope="col" class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    生产日期
                                </th>
                                <th scope="col" class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    有机认证
                                </th>
                                <th scope="col" class="px-6 py-3 bg-gray-50 dark:bg-gray-700 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    操作
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <tr v-for="product in filteredProducts" :key="product.id">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900 dark:text-white">
                                                {{ product.name }}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900 dark:text-white">{{ product.type }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900 dark:text-white">{{ product.region }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900 dark:text-white">{{ formatDate(product.plantingDate) }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span :class="product.isOrganic ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                        <span v-if="product.isOrganic" class="text-xs font-medium px-2 py-1 rounded-full">是</span>
                                        <span v-else class="text-xs font-medium px-2 py-1 rounded-full">否</span>
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button @click="viewProductDetail(product)" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-500">查看</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex items-center justify-between mt-6">
                    <div class="flex flex-1 justify-between space-x-4">
                        <button @click="prevPage" :disabled="currentPage === 1" class="px-4 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white">
                            上一页
                        </button>
                        <span class="text-sm text-gray-500 dark:text-gray-300">
                            第 {{ currentPage }} 页，共 {{ totalPages }} 页
                        </span>
                        <button @click="nextPage" :disabled="currentPage === totalPages" class="px-4 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white">
                            下一页
                        </button>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm text-gray-500 dark:text-gray-300">每页显示</span>
                        <select v-model="pageSize" class="form-input border p-1 rounded-md focus:outline-none text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option>10</option>
                            <option>20</option>
                            <option>50</option>
                            <option>100</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 产品详情弹窗 - 优化后更现代化的设计 -->
        <div v-if="selectedProduct" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 fade-in">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl product-detail-modal overflow-hidden flex flex-col light-card dark:dark-card max-w-4xl w-full">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gradient-to-r from-green-50 to-blue-50 dark:from-gray-800 dark:to-gray-700">
                    <h3 class="text-xl font-bold text-green-700 dark:text-green-400 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-green-600 dark:text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        {{ selectedProduct.name }} - 详细信息
                    </h3>
                    <button @click="closeProductDetail" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto">
                    <div class="product-detail-content gap-6">
                        <div class="flex-shrink-0 flex flex-col items-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <img :src="generateQRCodeUrl(selectedProduct.id)" alt="溯源码" class="w-32 h-32 md:w-40 md:h-40 object-contain mb-3 border-4 border-white dark:border-gray-600 shadow-md rounded-lg">
                            <span class="text-sm text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-800 px-3 py-1 rounded-full shadow-sm">扫码查看详情</span>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-5">
                            <h2 class="text-2xl font-bold text-green-700 dark:text-green-400 mb-4 border-b border-gray-100 dark:border-gray-700 pb-2">{{ selectedProduct.name }}</h2>

                            <div class="mb-4 flex items-center">
                                <span :class="selectedProduct.isOrganic ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:bg-opacity-30 dark:text-green-300' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'" class="px-3 py-1 rounded-full text-sm font-medium mr-2">
                                    {{ selectedProduct.type }}
                                </span>
                                <span :class="selectedProduct.isOrganic ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:bg-opacity-30 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:bg-opacity-30 dark:text-red-300'" class="px-3 py-1 rounded-full text-sm font-medium">
                                    {{ selectedProduct.isOrganic ? '有机认证' : '常规种植' }}
                                </span>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                                    <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                                        <svg class="w-4 h-4 mr-1 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        时间信息
                                    </h3>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-500 dark:text-gray-400">种植时间:</span>
                                            <span class="text-gray-800 dark:text-gray-200 font-medium">{{ formatDate(selectedProduct.plantingDate) }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-500 dark:text-gray-400">收获时间:</span>
                                            <span class="text-gray-800 dark:text-gray-200 font-medium">{{ formatDate(selectedProduct.harvestDate) }}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                                    <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                                        <svg class="w-4 h-4 mr-1 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        产地信息
                                    </h3>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-500 dark:text-gray-400">生产地区:</span>
                                            <span class="text-gray-800 dark:text-gray-200 font-medium">{{ selectedProduct.region }}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                                    <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                                        <svg class="w-4 h-4 mr-1 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                        </svg>
                                        批次信息
                                    </h3>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-500 dark:text-gray-400">生产批次:</span>
                                            <span class="text-gray-800 dark:text-gray-200 font-medium">{{ selectedProduct.batchNumber }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-500 dark:text-gray-400">产品ID:</span>
                                            <span class="text-gray-800 dark:text-gray-200 font-mono text-xs">{{ selectedProduct.id }}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                                    <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                                        <svg class="w-4 h-4 mr-1 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                        </svg>
                                        联系方式
                                    </h3>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-500 dark:text-gray-400">联系电话:</span>
                                            <a :href="'tel:' + selectedProduct.contact" class="text-blue-600 dark:text-blue-400 hover:underline font-medium flex items-center">
                                                {{ selectedProduct.contact }}
                                                <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                                </svg>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-green-50 dark:bg-gray-700 rounded-lg p-4 shadow-sm border border-green-100 dark:border-gray-600">
                            <h3 class="text-lg font-bold text-green-700 dark:text-green-400 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4m0-4v12m0 0V4"></path>
                                </svg>
                                营养成分分析
                            </h3>
                            <div class="overflow-hidden bg-white dark:bg-gray-800 rounded-lg shadow-sm">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600 text-sm">
                                    <thead>
                                        <tr>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider bg-gray-50 dark:bg-gray-700">
                                                成分
                                            </th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider bg-gray-50 dark:bg-gray-700">
                                                含量(g/100g)
                                            </th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider bg-gray-50 dark:bg-gray-700">
                                                营养水平
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200 dark:divide-gray-600">
                                        <tr v-for="(value, nutrient) in selectedProduct.nutrition" :key="nutrient" class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <div class="text-sm font-medium text-gray-900 dark:text-white">{{ nutrient }}</div>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <div class="text-sm text-gray-900 dark:text-white">{{ value }}</div>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5">
                                                    <div class="bg-green-500 h-2.5 rounded-full" :style="{ width: Math.min(value * 5, 100) + '%' }"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3 text-xs text-gray-500 dark:text-gray-400">
                                * 数据来源：中国食品成分表(2019版)
                            </div>
                        </div>
                        <div class="bg-blue-50 dark:bg-gray-700 rounded-lg p-4 shadow-sm border border-blue-100 dark:border-gray-600">
                            <h3 class="text-lg font-bold text-blue-700 dark:text-blue-400 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                地理位置信息
                            </h3>
                            <div class="h-56 rounded-lg overflow-hidden shadow-sm" id="productLocationMap"></div>
                            <div class="mt-3 bg-white dark:bg-gray-800 rounded-lg p-3 shadow-sm">
                                <div class="flex items-center text-sm">
                                    <svg class="w-4 h-4 text-green-600 dark:text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span class="text-gray-700 dark:text-gray-300 font-medium">产地：</span>
                                    <span class="text-gray-900 dark:text-white ml-1">{{ selectedProduct.region }}</span>
                                </div>
                                <div v-if="selectedProduct.latitude && selectedProduct.longitude" class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                                    精确坐标：{{ selectedProduct.latitude.toFixed(4) }}, {{ selectedProduct.longitude.toFixed(4) }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="selectedProduct.news" class="mt-6 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-bold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-yellow-500 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            农业新闻
                        </h3>
                        <div class="text-sm text-gray-700 dark:text-gray-300 mb-2">
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200">{{ selectedProduct.news.title }}</h4>
                            <p class="mt-1">{{ selectedProduct.news.content }}</p>
                        </div>
                        <div class="mt-2 text-xs text-gray-500 dark:text-gray-400 flex items-center">
                            <svg class="w-3 h-3 mr-1 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            {{ formatDate(selectedProduct.news.date) }}
                        </div>
                    </div>

                    <div class="mt-4 flex justify-end space-x-3">
                        <button @click="closeProductDetail" class="bg-gray-200 text-gray-900 px-4 py-1.5 text-sm rounded-md hover:bg-gray-300 transition-colors duration-300 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600">
                            关闭
                        </button>
                        <a :href="generateDetailPageUrl(selectedProduct.id)" target="_blank" class="bg-green-600 text-white px-4 py-1.5 text-sm rounded-md hover:bg-green-700 transition-colors duration-300 dark:bg-green-700 dark:hover:bg-green-800">
                            查看完整溯源信息
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 高德地图配置
        window._AMapSecurityConfig = {
            securityJsCode: 'd923255fe177efb202c35546cbc00a53' // 安全密钥
        };

        new Vue({
            el: '#app',
            data: {
                darkMode: true,
                allProducts: [],
                filteredProducts: [],
                currentPage: 1,
                pageSize: 20,
                filters: {
                    productName: '',
                    startDate: '',
                    endDate: '',
                    region: '',
                    productType: ''
                },
                productTypeCounts: {},
                totalProducts: 0,
                thisMonthProducts: 0,
                organicProducts: 0,
                activeToday: 0,
                selectedProduct: null,
                map: null,
                productMarkers: [],
                locationMap: null
            },
            computed: {
                totalPages() {
                    return Math.ceil(this.filteredProducts.length / this.pageSize);
                },
                displayedProducts() {
                    const startIndex = (this.currentPage - 1) * this.pageSize;
                    const endIndex = startIndex + this.pageSize;
                    return this.filteredProducts.slice(startIndex, endIndex);
                }
            },
            mounted() {
                this.loadData();
            },
            methods: {
                toggleDarkMode() {
                    this.darkMode = !this.darkMode;
                    document.body.classList.toggle('dark-mode', this.darkMode);
                },
                async exportPDF() {
                    const { jsPDF } = window.jspdf;
                    const element = document.querySelector('.container'); // 需要导出的HTML元素
                    const pdf = new jsPDF('landscape', 'mm', 'a4');
                    const canvas = await html2canvas(element, {
                        scrollX: -window.scrollX,
                        scrollY: -window.scrollY,
                        scale: 2
                    });
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 280;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    const pageHeight = 190; // A4纸高度
                    let heightLeft = imgHeight;
                    let position = 0;
                    let page = 1;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save('溯源码数据分析报表.pdf');
                },
                async loadData() {
                    this.isLoading = true;

                    // 加载产品数据
                    try {
                        const response = await fetch(`qrcodes.json?t=${new Date().getTime()}`, {
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();

                        // 处理数据并填充 allProducts
                        this.processData(data);

                        // 初始化图表
                        this.initCharts();

                        // 初始化地图
                        this.initMap();

                        this.isLoading = false;
                    } catch (error) {
                        console.error('加载数据失败:', error);
                        this.isLoading = false;
                    }
                },
                processData(data) {
                    // 模拟从 qrcodes.json 中提取产品数据的逻辑
                    // 这里假设 qrcodes.json 格式为按周组织的产品数据
                    this.allProducts = [];

                    // 模拟产品数据
                    const now = new Date();
                    const oneMonthAgo = new Date(now);
                    oneMonthAgo.setMonth(now.getMonth() - 1);

                    // 模拟生成50个具体产品数据
                    const productTypes = ['蔬菜', '水果', '粮食', '肉类', '水产', '蛋奶'];
                    const regions = ['河南省', '山东省', '江苏省', '河北省', '山西省', '安徽省', '黑龙江省', '吉林省', '辽宁省', '湖北省'];

                    // 更具体的产品名称
                    const specificProducts = {
                        '蔬菜': ['有机西红柿', '绿色菠菜', '无公害黄瓜', '有机胡萝卜', '生态白菜', '有机青椒', '绿色茄子', '有机土豆', '生态西红柿', '有机生菜'],
                        '水果': ['有机苹果', '生态香蕉', '无公害橙子', '有机葡萄', '生态西瓜', '有机草莓', '绿色猕猴桃', '有机柚子', '生态梨', '有机蓝莓'],
                        '粮食': ['五常大米', '有机小米', '东北黑土地大豆', '有机燕麦', '绿色玉米', '有机黑米', '生态红豆', '有机糙米', '有机高粱', '生态薏米'],
                        '肉类': ['草饲牛肉', '有机猪肉', '放养鸡肉', '生态羊肉', '有机鸭肉', '绿色兔肉', '生态火鸡肉', '有机鹿肉', '山养猪肉', '生态牦牛肉'],
                        '水产': ['生态草鱼', '有机虾', '绿色螃蟹', '有机鲈鱼', '生态鲤鱼', '有机贝类', '野生活鱼', '有机鳗鱼', '生态泥鳅', '有机河蚌'],
                        '蛋奶': ['有机鸡蛋', '生态鸭蛋', '有机牛奶', '绿色羊奶', '有机奶酪', '生态鹅蛋', '有机酸奶', '生态鹌鹑蛋', '有机奶豆腐', '生态奶油']
                    };

                    // 营养成分数据库
                    const nutritionDB = {
                        '蔬菜': {
                            '蛋白质': [0.7, 2.9],
                            '脂肪': [0.1, 0.4],
                            '碳水化合物': [2.9, 9.6],
                            '膳食纤维': [0.5, 2.8],
                            '维生素C': [2.2, 80.4],
                            '钙': [10, 73],
                            '铁': [0.3, 2.7]
                        },
                        '水果': {
                            '蛋白质': [0.3, 1.1],
                            '脂肪': [0.1, 0.4],
                            '碳水化合物': [7.6, 22.8],
                            '膳食纤维': [0.4, 2.6],
                            '维生素C': [3.2, 58.8],
                            '钙': [5, 40],
                            '铁': [0.1, 0.4]
                        },
                        '粮食': {
                            '蛋白质': [3.2, 16.9],
                            '脂肪': [0.7, 6.9],
                            '碳水化合物': [19.02, 77.8],
                            '膳食纤维': [0.6, 12.2],
                            '维生素C': [0, 6.8],
                            '钙': [2, 54],
                            '铁': [0.5, 4.7]
                        },
                        '肉类': {
                            '蛋白质': [15.0, 22.0],
                            '脂肪': [5.0, 30.0],
                            '碳水化合物': [0, 1.0],
                            '膳食纤维': [0, 0],
                            '维生素C': [0, 0],
                            '钙': [5, 20],
                            '铁': [1.0, 3.5]
                        },
                        '水产': {
                            '蛋白质': [15.0, 20.0],
                            '脂肪': [0.5, 10.0],
                            '碳水化合物': [0, 2.0],
                            '膳食纤维': [0, 0],
                            '维生素C': [0, 2.0],
                            '钙': [20, 100],
                            '铁': [0.5, 2.0]
                        },
                        '蛋奶': {
                            '蛋白质': [3.0, 13.0],
                            '脂肪': [3.0, 10.0],
                            '碳水化合物': [0, 5.0],
                            '膳食纤维': [0, 0],
                            '维生素C': [0, 1.0],
                            '钙': [50, 120],
                            '铁': [0.2, 2.0]
                        }
                    };

                    // 生成随机范围内的数值
                    const randomInRange = (min, max) => {
                        return (Math.random() * (max - min) + min).toFixed(2);
                    };

                    for (let i = 1; i <= 50; i++) {
                        const typeIndex = Math.floor(Math.random() * productTypes.length);
                        const type = productTypes[typeIndex];
                        const isOrganic = Math.random() > 0.5;

                        // 选择具体产品名称
                        const productList = specificProducts[type];
                        const productName = productList[Math.floor(Math.random() * productList.length)];

                        // 生成合理的种植和收获日期
                        const plantingDate = new Date(
                            now.getFullYear(),
                            now.getMonth() - Math.floor(Math.random() * 6) - 1, // 1-6个月前种植
                            Math.floor(Math.random() * 28) + 1
                        );

                        // 收获日期在种植日期之后的1-3个月
                        const harvestDate = new Date(plantingDate);
                        harvestDate.setMonth(plantingDate.getMonth() + Math.floor(Math.random() * 3) + 1);

                        // 根据产品类型生成合理的营养成分
                        const nutrition = {};
                        const typeNutrition = nutritionDB[type];

                        for (const [nutrient, range] of Object.entries(typeNutrition)) {
                            nutrition[nutrient] = randomInRange(range[0], range[1]);
                        }

                        // 生成地理位置 - 根据地区设置合理的经纬度范围
                        const regionIndex = Math.floor(Math.random() * regions.length);
                        const region = regions[regionIndex];

                        // 根据地区设置大致的经纬度范围
                        let latitude, longitude;
                        switch(region) {
                            case '河南省':
                                latitude = randomInRange(32.0, 36.0);
                                longitude = randomInRange(110.0, 116.0);
                                break;
                            case '山东省':
                                latitude = randomInRange(34.0, 38.0);
                                longitude = randomInRange(115.0, 122.0);
                                break;
                            case '江苏省':
                                latitude = randomInRange(30.0, 35.0);
                                longitude = randomInRange(116.0, 121.0);
                                break;
                            case '河北省':
                                latitude = randomInRange(36.0, 42.0);
                                longitude = randomInRange(113.0, 119.0);
                                break;
                            case '山西省':
                                latitude = randomInRange(34.0, 40.0);
                                longitude = randomInRange(110.0, 114.0);
                                break;
                            case '安徽省':
                                latitude = randomInRange(29.0, 34.0);
                                longitude = randomInRange(115.0, 119.0);
                                break;
                            case '黑龙江省':
                                latitude = randomInRange(43.0, 53.0);
                                longitude = randomInRange(121.0, 135.0);
                                break;
                            case '吉林省':
                                latitude = randomInRange(41.0, 46.0);
                                longitude = randomInRange(122.0, 131.0);
                                break;
                            case '辽宁省':
                                latitude = randomInRange(38.0, 43.0);
                                longitude = randomInRange(118.0, 125.0);
                                break;
                            case '湖北省':
                                latitude = randomInRange(29.0, 33.0);
                                longitude = randomInRange(108.0, 116.0);
                                break;
                            default:
                                latitude = 35 + (Math.random() * 5 - 2.5);
                                longitude = 115 + (Math.random() * 5 - 2.5);
                        }

                        // 添加农业生产技术信息
                        const farmingTech = type === '蔬菜' || type === '水果'
                            ? '智能灌溉'
                            : type === '粮食'
                                ? '精准施肥'
                                : type === '肉类' || type === '蛋奶'
                                    ? '生态养殖'
                                    : '深海养殖';

                        this.allProducts.push({
                            id: `prod-${i}`,
                            name: productName,
                            type: type,
                            region: region,
                            plantingDate: plantingDate.toISOString().split('T')[0],
                            harvestDate: harvestDate.toISOString().split('T')[0],
                            batchNumber: `B${Math.floor(Math.random() * 10000)}`,
                            contact: `1${Math.floor(Math.random() * 9000000000) + 1000000000}`,
                            isOrganic: isOrganic,
                            latitude: parseFloat(latitude),
                            longitude: parseFloat(longitude),
                            nutrition: nutrition,
                            farmingTech: farmingTech
                        });
                    }

                    // 计算统计数据
                    this.calculateStats();

                    // 应用初始筛选
                    this.applyFilters();
                },
                calculateStats() {
                    // 计算产品类型分布
                    const typeCounts = {};
                    this.allProducts.forEach(product => {
                        if (!typeCounts[product.type]) {
                            typeCounts[product.type] = 0;
                        }
                        typeCounts[product.type]++;
                    });
                    this.productTypeCounts = typeCounts;

                    // 计算总数
                    this.totalProducts = this.allProducts.length;

                    // 计算本月新增
                    const now = new Date();
                    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                    this.thisMonthProducts = this.allProducts.filter(product =>
                        product.plantingDate >= thisMonthStart
                    ).length;

                    // 计算有机认证产品数量
                    this.organicProducts = this.allProducts.filter(product => product.isOrganic).length;

                    // 计算今日活跃（模拟数据）
                    this.activeToday = Math.floor(Math.random() * 30) + 10;
                },
                initCharts() {
                    // 产品类型分布图表
                    const productTypeChart = echarts.init(document.getElementById('productTypeChart'));
                    const typeChartOption = {
                        tooltip: {
                            trigger: 'item',
                            formatter: '{a} <br/>{b}: {c} ({d}%)'
                        },
                        legend: {
                            orient: 'vertical',
                            right: 10,
                            top: 'center',
                            textStyle: {
                                color: this.darkMode ? '#e2e8f0' : '#4a5568'
                            }
                        },
                        series: [
                            {
                                name: '产品类型',
                                type: 'pie',
                                radius: ['40%', '70%'],
                                avoidLabelOverlap: false,
                                label: {
                                    show: false,
                                    position: 'center'
                                },
                                emphasis: {
                                    label: {
                                        show: true,
                                        fontSize: '18',
                                        fontWeight: 'bold',
                                        color: this.darkMode ? '#e2e8f0' : '#4a5568'
                                    }
                                },
                                labelLine: {
                                    show: false
                                },
                                data: Object.entries(this.productTypeCounts).map(([type, count]) => ({
                                    value: count,
                                    name: type
                                }))
                            }
                        ],
                        color: ['#58d68d', '#f1c40f', '#3498db', '#e74c3c', '#9b59b6', '#e67e22', '#1abc9c', '#34495e']
                    };
                    productTypeChart.setOption(typeChartOption);

                    // 产品数量趋势图表
                    const trendChart = echarts.init(document.getElementById('productTrendChart'));
                    const trendChartOption = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            }
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                            axisLine: {
                                lineStyle: {
                                    color: this.darkMode ? '#6b7280' : '#4a5568'
                                }
                            },
                            axisLabel: {
                                color: this.darkMode ? '#e2e8f0' : '#4a5568'
                            }
                        },
                        yAxis: {
                            type: 'value',
                            axisLine: {
                                show: true,
                                lineStyle: {
                                    color: this.darkMode ? '#6b7280' : '#4a5568'
                                }
                            },
                            axisLabel: {
                                color: this.darkMode ? '#e2e8f0' : '#4a5568'
                            },
                            splitLine: {
                                lineStyle: {
                                    color: this.darkMode ? '#374151' : '#edf2f7'
                                }
                            }
                        },
                        series: [
                            {
                                name: '生产数量',
                                type: 'bar',
                                data: [120, 132, 101, 134, 90, 230, 210, 182, 191, 234, 290, 330],
                                itemStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        {offset: 0, color: '#58d68d'},
                                        {offset: 1, color: '#e8f5e9'}
                                    ])
                                }
                            }
                        ]
                    };
                    trendChart.setOption(trendChartOption);

                    // 地区分布图表
                    const regionChart = echarts.init(document.getElementById('regionDistributionChart'));
                    const regionChartOption = {
                        tooltip: {
                            trigger: 'item',
                            formatter: '{a} <br/>{b}: {c} ({d}%)'
                        },
                        legend: {
                            orient: 'vertical',
                            right: 10,
                            top: 'center',
                            textStyle: {
                                color: this.darkMode ? '#e2e8f0' : '#4a5568'
                            }
                        },
                        series: [
                            {
                                name: '地区分布',
                                type: 'pie',
                                radius: ['40%', '70%'],
                                center: ['40%', '50%'],
                                avoidLabelOverlap: false,
                                label: {
                                    show: false,
                                    position: 'center'
                                },
                                emphasis: {
                                    label: {
                                        show: true,
                                        fontSize: '18',
                                        fontWeight: 'bold',
                                        color: this.darkMode ? '#e2e8f0' : '#4a5568'
                                    }
                                },
                                labelLine: {
                                    show: false
                                },
                                data: [
                                    {value: 335, name: '河南省'},
                                    {value: 310, name: '山东省'},
                                    {value: 234, name: '江苏省'},
                                    {value: 135, name: '河北省'},
                                    {value: 154, name: '山西省'},
                                    {value: 90, name: '安徽省'}
                                ]
                            }
                        ],
                        color: ['#3498db', '#58d68d', '#f1c40f', '#e74c3c', '#9b59b6', '#e67e22']
                    };
                    regionChart.setOption(regionChartOption);

                    // 营养成分分析图表
                    const nutritionChart = echarts.init(document.getElementById('nutritionChart'));
                    const nutritionChartOption = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            }
                        },
                        legend: {
                            data: ['平均值', '最大值', '最小值'],
                            textStyle: {
                                color: this.darkMode ? '#e2e8f0' : '#4a5568'
                            }
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: ['蛋白质', '脂肪', '碳水化合物', '膳食纤维', '维生素C', '钙', '铁'],
                            axisLine: {
                                lineStyle: {
                                    color: this.darkMode ? '#6b7280' : '#4a5568'
                                }
                            },
                            axisLabel: {
                                color: this.darkMode ? '#e2e8f0' : '#4a5568'
                            }
                        },
                        yAxis: {
                            type: 'value',
                            axisLine: {
                                show: true,
                                lineStyle: {
                                    color: this.darkMode ? '#6b7280' : '#4a5568'
                                }
                            },
                            axisLabel: {
                                color: this.darkMode ? '#e2e8f0' : '#4a5568'
                            },
                            splitLine: {
                                lineStyle: {
                                    color: this.darkMode ? '#374151' : '#edf2f7'
                                }
                            }
                        },
                        series: [
                            {
                                name: '平均值',
                                type: 'bar',
                                data: [2.5, 1.2, 5.3, 1.8, 50.2, 25.4, 8.7],
                                itemStyle: {
                                    color: '#58d68d'
                                }
                            },
                            {
                                name: '最大值',
                                type: 'bar',
                                data: [4.2, 3.1, 12.5, 3.7, 80.5, 45.2, 15.3],
                                itemStyle: {
                                    color: '#3498db'
                                }
                            },
                            {
                                name: '最小值',
                                type: 'bar',
                                data: [0.8, 0.3, 1.2, 0.5, 20.1, 5.6, 2.1],
                                itemStyle: {
                                    color: '#e74c3c'
                                }
                            }
                        ]
                    };
                    nutritionChart.setOption(nutritionChartOption);

                    // 窗口大小变化时重绘图表
                    window.addEventListener('resize', () => {
                        productTypeChart.resize();
                        trendChart.resize();
                        regionChart.resize();
                        nutritionChart.resize();
                    });
                },
                initMap() {
                    // 初始化主地图
                    AMapLoader.load({
                        key: "5ad852daa54b2ec5cc25ea383499b9b3",
                        version: "2.0",
                        plugins: ["AMap.Marker"]
                    })
                    .then(AMap => {
                        this.map = new AMap.Map("mapContainer", {
                            resizeEnable: true,
                            center: [114.3519, 34.7991], // 开封市
                            zoom: 7
                        });

                        // 添加产品位置标记
                        this.filteredProducts.forEach(product => {
                            if (product.longitude && product.latitude) {
                                const marker = new AMap.Marker({
                                    position: [product.longitude, product.latitude],
                                    title: product.name,
                                    extData: product
                                });

                                // 添加点击事件
                                marker.on('click', (e) => {
                                    const product = e.target.getExtData();
                                    this.viewProductDetail(product);
                                });

                                this.map.add(marker);
                                this.productMarkers.push(marker);
                            }
                        });
                    })
                    .catch(e => {
                        console.error('地图加载失败:', e);
                    });
                },
                initProductLocationMap(product) {
                    if (!product.longitude || !product.latitude) return;

                    AMapLoader.load({
                        key: "5ad852daa54b2ec5cc25ea383499b9b3",
                        version: "2.0",
                        plugins: ["AMap.Marker"]
                    })
                    .then(AMap => {
                        this.locationMap = new AMap.Map("productLocationMap", {
                            resizeEnable: true,
                            center: [product.longitude, product.latitude],
                            zoom: 14
                        });

                        const marker = new AMap.Marker({
                            position: [product.longitude, product.latitude],
                            title: product.name
                        });

                        this.locationMap.add(marker);
                    })
                    .catch(e => {
                        console.error('产品地图加载失败:', e);
                    });
                },
                formatDate(dateString) {
                    if (!dateString) return '未设置';

                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return dateString;

                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                },
                generateQRCodeUrl(productId) {
                    return `${location.origin}/p.html?id=${productId}`;
                },
                generateDetailPageUrl(productId) {
                    return `${location.origin}/product-detail.html?id=${productId}`;
                },
                applyFilters() {
                    let results = [...this.allProducts];

                    // 应用产品名称筛选
                    if (this.filters.productName) {
                        const nameFilter = this.filters.productName.toLowerCase();
                        results = results.filter(product =>
                            product.name.toLowerCase().includes(nameFilter)
                        );
                    }

                    // 应用日期范围筛选
                    if (this.filters.startDate || this.filters.endDate) {
                        const startDate = this.filters.startDate ? new Date(this.filters.startDate) : new Date(0);
                        const endDate = this.filters.endDate ? new Date(this.filters.endDate) : new Date();

                        results = results.filter(product => {
                            const productDate = new Date(product.plantingDate);
                            return productDate >= startDate && productDate <= endDate;
                        });
                    }

                    // 应用地区筛选
                    if (this.filters.region) {
                        const regionFilter = this.filters.region.toLowerCase();
                        results = results.filter(product =>
                            product.region.toLowerCase().includes(regionFilter)
                        );
                    }

                    // 应用产品类型筛选
                    if (this.filters.productType) {
                        results = results.filter(product =>
                            product.type === this.filters.productType
                        );
                    }

                    this.filteredProducts = results;
                    this.currentPage = 1;

                    // 更新地图标记
                    this.updateMapMarkers();
                },
                resetFilters() {
                    this.filters = {
                        productName: '',
                        startDate: '',
                        endDate: '',
                        region: '',
                        productType: ''
                    };
                    this.applyFilters();
                },
                updateMapMarkers() {
                    if (!this.map) return;

                    // 清除现有标记
                    this.productMarkers.forEach(marker => {
                        this.map.remove(marker);
                    });
                    this.productMarkers = [];

                    // 添加新的标记
                    this.filteredProducts.forEach(product => {
                        if (product.longitude && product.latitude) {
                            const marker = new AMap.Marker({
                                position: [product.longitude, product.latitude],
                                title: product.name,
                                extData: product
                            });

                            // 添加点击事件
                            marker.on('click', (e) => {
                                const product = e.target.getExtData();
                                this.viewProductDetail(product);
                            });

                            this.map.add(marker);
                            this.productMarkers.push(marker);
                        }
                    });

                    // 调整地图视图以适应所有标记
                    if (this.productMarkers.length > 0) {
                        const bounds = this.productMarkers.reduce((prev, marker) => {
                            return prev.extend(marker.getPosition());
                        }, new AMap.Bounds());

                        this.map.setFitView(this.productMarkers);
                    } else {
                        // 如果没有标记，恢复到默认视图
                        this.map.setCenter([114.3519, 34.7991]);
                        this.map.setZoom(7);
                    }
                },
                async fetchAgricultureNews(productType) {
                  try {
                    const response = await fetch('http://localhost:3001/api/deepseek/chat/complete', { // 请求后端代理
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `sk-c9c50c09d0a2464f909a238507b21db4` // 使用你的API密钥
                      },
                      body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                          {
                            role: 'user',
                            content: `请提供一条关于${productType}的最新农业新闻，包括标题和简要内容，并指定新闻发布日期。`
                          }
                        ]
                      })
                    });

                    if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.choices && data.choices.length > 0) {
                      const content = data.choices[0].message.content;
                      const titleMatch = content.match(/标题：(.+?)(\n|$)/i);
                      const contentMatch = content.match(/内容：(.+?)(\n|$)/i);

                      if (titleMatch && contentMatch) {
                        const title = titleMatch[1].trim();
                        const content = contentMatch[1].trim();
                        const date = new Date().toISOString().split('T')[0];

                        return {
                          title,
                          content,
                          date
                        };
                      }
                    }

                    return this.getDefaultAgricultureNews(productType);
                  } catch (error) {
                    console.error('获取农业新闻失败:', error);
                    return this.getDefaultAgricultureNews(productType);
                  }
                },
                getDefaultAgricultureNews(productType) {
                    // 默认新闻数据库
                    const newsDatabase = {
                        '蔬菜': [
                            { title: '有机蔬菜市场需求持续增长', content: '近期调查显示，有机蔬菜市场在过去一年增长了15%，消费者对健康食品的需求不断提高。', date: new Date().toISOString().split('T')[0] },
                            { title: '新型蔬菜种植技术提高产量', content: '采用智能灌溉和精准施肥技术，蔬菜产量提升20%，同时减少了30%的水资源消耗。', date: new Date().toISOString().split('T')[0] },
                            { title: '反季节蔬菜价格趋于稳定', content: '得益于温室技术的普及，反季节蔬菜供应充足，价格较去年同期下降约8%。', date: new Date().toISOString().split('T')[0] }
                        ],
                        '水果': [
                            { title: '水果出口创历史新高', content: '今年前三季度，我国水果出口额同比增长12.3%，其中猕猴桃和柑橘类水果表现尤为突出。', date: new Date().toISOString().split('T')[0] },
                            { title: '气候变化影响水果品质', content: '研究表明，气候变暖导致部分水果糖分含量上升，但也增加了病虫害风险。', date: new Date().toISOString().split('T')[0] },
                            { title: '小型水果受年轻消费者青睐', content: '便携、少量、高品质的小型水果在年轻消费群体中走俏，价格较普通品种高出约30%。', date: new Date().toISOString().split('T')[0] }
                        ],
                        '粮食': [
                            { title: '粮食储备充足保障粮食安全', content: '国家粮食局报告显示，我国主要粮食作物储备量较去年增加15%，可满足6个月以上消费需求。', date: new Date().toISOString().split('T')[0] },
                            { title: '耐盐碱水稻种植技术获重大突破', content: '袁隆平团队研发的耐盐碱水稻新品种在沿海滩涂试种成功，亩产突破400公斤。', date: new Date().toISOString().split('T')[0] },
                            { title: '粮食深加工产业快速发展', content: '我国粮食深加工转化率提高至83%，高附加值粮食产品出口额同比增长25%。', date: new Date().toISOString().split('T')[0] }
                        ],
                        '肉类': [
                            { title: '畜牧业数字化转型加速', content: '智能养殖系统可提高饲料转化率15%，降低死亡率30%，目前已在全国5000家养殖场推广。', date: new Date().toISOString().split('T')[0] },
                            { title: '肉类消费结构发生变化', content: '随着健康意识提升，消费者对禽肉和水产的消费比例上升，猪肉消费占比下降至58%。', date: new Date().toISOString().split('T')[0] },
                            { title: '肉类冷链物流覆盖范围扩大', content: '全国冷链物流覆盖率达到75%，肉类运输损耗降低至5%以下，有效保障了产品品质。', date: new Date().toISOString().split('T')[0] }
                        ],
                        '水产': [
                            { title: '海洋牧场建设成效显著', content: '我国已建成国家级海洋牧场示范区120个，海水养殖产量占水产品总产量的52%。', date: new Date().toISOString().split('T')[0] },
                            { title: '水产养殖绿色发展模式推广', content: '稻渔综合种养面积达3500万亩，实现"一水两用、一田双收"，亩均增收1500元。', date: new Date().toISOString().split('T')[0] },
                            { title: '水产品质量安全水平提升', content: '水产养殖用药减量行动成效明显，主要养殖品种药残检测合格率达99.4%，较去年提高1.2个百分点。', date: new Date().toISOString().split('T')[0] }
                        ],
                        '蛋奶': [
                            { title: '奶业振兴行动计划成效显著', content: '我国奶类产量连续四年增长，人均奶类消费量达42.5公斤，提前实现"十四五"规划目标。', date: new Date().toISOString().split('T')[0] },
                            { title: '蛋鸡养殖智能化水平提升', content: '智能蛋鸡养殖系统可自动调控环境、监测健康、收集鸡蛋，人力成本降低40%。', date: new Date().toISOString().split('T')[0] },
                            { title: '特色奶制品市场潜力巨大', content: '牦牛奶、骆驼奶等特色奶制品市场增长率达25%，消费者对其营养价值和特色风味认可度高。', date: new Date().toISOString().split('T')[0] }
                        ]
                    };

                    // 返回随机一条默认新闻
                    const newsList = newsDatabase[productType] || [];
                    if (newsList.length > 0) {
                        return newsList[Math.floor(Math.random() * newsList.length)];
                    }

                    // 如果没有对应类型，返回通用新闻
                    return {
                        title: '农业科技助力乡村振兴',
                        content: '近年来，我国农业科技成果转化率不断提高，为农业增效、农民增收提供了有力支撑。',
                        date: new Date().toISOString().split('T')[0]
                    };
                },
                async viewProductDetail(product) {
                    this.selectedProduct = product;
                    this.initProductLocationMap(product);
                    document.body.style.overflow = 'hidden'; // 防止背景滚动

                    // 如果产品没有新闻，从API获取
                    if (!product.news) {
                        try {
                            product.news = await this.fetchAgricultureNews(product.type);
                        } catch (error) {
                            console.error('获取农业新闻失败，使用默认新闻:', error);
                            product.news = this.getDefaultAgricultureNews(product.type);
                        }
                    }
                },
                closeProductDetail() {
                    this.selectedProduct = null;
                    document.body.style.overflow = ''; // 恢复背景滚动
                },
                prevPage() {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                    }
                },
                nextPage() {
                    if (this.currentPage < this.totalPages) {
                        this.currentPage++;
                    }
                }
            }
        });
    </script>
</body>
</html>