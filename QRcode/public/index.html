<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å†œåœºå†œäº§å“æº¯æºç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .qrcode-container {
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .bg-pattern {
            background-color: #f0f8f0;
            background-image: linear-gradient(rgba(144, 238, 144, 0.1) 1px, transparent 1px),
                            linear-gradient(90deg, rgba(144, 238, 144, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* æ–°å¢è¡¨å•è¾“å…¥åŠ¨ç”»æ•ˆæœ */
        .form-input:focus {
            @apply border-green-500 shadow-sm;
            transition: all 0.3s ease;
        }

        .form-input {
            transition: all 0.3s ease;
        }

        .form-input:focus + label {
            @apply text-green-500;
        }

        .map-container {
            width: 100%;
            height: 400px;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ–æ ·å¼ */
        @media (max-width: 640px) {
            .qrcode-container {
                width: 180px;
                height: 180px;
            }

            .form-input, select, button {
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
                padding: 12px;
                height: auto;
                min-height: 44px; /* ç¡®ä¿è§¦æ‘¸åŒºåŸŸè¶³å¤Ÿå¤§ */
            }

            .map-container {
                height: 300px;
            }

            nav .container {
                padding: 0 10px;
            }

            .batch-section {
                padding: 15px;
            }

            /* æ”¹å–„ç§»åŠ¨ç«¯å¯¼èˆªæ  */
            nav {
                padding: 10px 0;
            }

            nav .flex.space-x-2 {
                margin-top: 5px;
            }

            /* æ”¹å–„ç§»åŠ¨ç«¯æŒ‰é’® */
            .download-btn, button[type="submit"], button.bg-green-600 {
                width: 100%;
                margin-top: 10px;
                padding: 12px;
                font-size: 16px;
            }

            /* æ”¹å–„è¡¨å•å¸ƒå±€ */
            .grid.grid-cols-1.gap-4.md\:grid-cols-2 {
                gap: 12px;
            }

            /* å¢åŠ è¡¨å•å…ƒç´ é—´è· */
            .flex.flex-col.space-y-2 {
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- å¯¼èˆªæ  - å›ºå®šåœ¨é¡¶éƒ¨ï¼Œä¼˜åŒ–ç§»åŠ¨ç«¯æ˜¾ç¤º -->
        <nav class="bg-white shadow-md p-4 sticky top-0 z-50 w-full">
            <div class="container mx-auto flex flex-wrap justify-between items-center">
                <div class="flex items-center">
                    <span class="text-xl font-bold text-green-700">æ™ºæ…§å†œåœºæº¯æºç³»ç»Ÿ</span>
                </div>
                <div class="flex space-x-2 md:space-x-4 text-sm md:text-base">
                    <a href="#" class="text-green-600 hover:text-green-800 px-2 py-1">é¦–é¡µ</a>
                    <a href="#" class="text-green-600 hover:text-green-800 px-2 py-1">å…³äºæˆ‘ä»¬</a>
                    <a href="analysis.html" target="_blank" class="text-green-600 hover:text-green-800 px-2 py-1">æ•°æ®åˆ†æ</a>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-8">

        <!-- æ‰¹é‡å¤„ç†è¿›åº¦æç¤º -->
        <div v-if="uploadStatus.loading" class="bg-blue-100 border-blue-400 text-blue-700 p-4 rounded-lg mb-4">
            <div class="flex items-center">
                <svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>{{ uploadStatus.message }}</span>
            </div>
        </div>

        <div v-if="uploadStatus.success" class="bg-green-100 border-green-400 text-green-700 p-4 rounded-lg mb-4">
            <div class="flex items-center">
                <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>{{ uploadStatus.message }}</span>
            </div>
        </div>

        <div v-if="uploadStatus.error" class="bg-red-100 border-red-400 text-red-700 p-4 rounded-lg mb-4">
            <div class="flex items-center">
                <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <span>{{ uploadStatus.message }}</span>
            </div>
        </div>

        <div class="batch-section bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="text-center mb-4">
                <svg class="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <h3 class="mt-2 text-lg font-semibold text-gray-800">æ‰¹é‡ç”Ÿæˆå†œä½œç‰©æº¯æºç </h3>
                <p class="mt-1 text-sm text-gray-500">è¯·ä¸Šä¼ åŒ…å«å†œä½œç‰©ä¿¡æ¯çš„Excelæ–‡ä»¶ï¼ˆæ”¯æŒ.xlsxæ ¼å¼ï¼‰</p>
                <p class="text-xs text-gray-400 mt-2">æ–‡ä»¶åº”åŒ…å«ï¼šäº§å“åç§°ã€ç§æ¤åœ°ç‚¹ã€ç§æ¤æ—¶é—´ç­‰å¿…è¦å­—æ®µ</p>
            </div>
            <div class="flex flex-col items-center space-y-4">
                <label class="w-full cursor-pointer">
                    <input type="file" @change="handleExcelUpload" accept=".xlsx"
                        class="upload-input opacity-0 absolute z-0">
                    <div class="bg-green-50 text-green-700 hover:bg-green-100 px-6 py-3 rounded-md border-2 border-dashed border-green-200
                        transition-colors duration-200 w-full text-center flex items-center justify-center">
                        <span class="mr-2">é€‰æ‹©Excelæ–‡ä»¶</span>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path>
                        </svg>
                    </div>
                </label>
                <button @click="downloadBatchQRCodes" :disabled="!batchCodes.length"
                    class="download-btn bg-green-600 hover:bg-green-700 text-white px-6 sm:px-8 py-3 rounded-md
                    transition-colors duration-300 flex items-center justify-center w-full sm:w-auto text-base sm:text-lg
                    disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 01-3 3H1m0 0l3-3m-3 3V1m5 4a3 3 0 01-3-3H4a3 3 0 013-3m0 3a3 3 0 003 3h3a3 3 0 003-3m0 3a3 3 0 01-3-3H4a3 3 0 013-3"></path>
                    </svg>
                    æ‰“åŒ…ä¸‹è½½å…¨éƒ¨äºŒç»´ç 
                </button>
            </div>
        </div>
        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-content">
            <div class="container mx-auto px-4">
                <!-- ç”Ÿæˆæº¯æºç éƒ¨åˆ† -->
                <div class="bg-white rounded-lg shadow-md p-8 mb-8">
                    <h2 class="text-2xl font-bold text-center text-green-700 mb-6">ç”Ÿæˆå†œäº§å“æº¯æºç </h2>
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-2 sm:grid-cols-1">
                            <div class="flex flex-col space-y-2">
                                <label class="text-gray-700">äº§å“åç§° <span class="text-red-500">*</span></label>
                                <input v-model="product.name" type="text" class="form-input border p-2 rounded-md focus:outline-none" placeholder="è¯·è¾“å…¥äº§å“åç§°">
                            </div>
                            <div class="flex flex-col space-y-2">
                                <label class="text-gray-700">ç§æ¤æ—¶é—´</label>
                                <input v-model="product.plantingDate" type="date" class="form-input border p-2 rounded-md focus:outline-none">
                            </div>
                            <div class="flex flex-col space-y-2">
                                <label class="text-gray-700">æ”¶è·æ—¶é—´</label>
                                <input v-model="product.harvestDate" type="date" class="form-input border p-2 rounded-md focus:outline-none">
                            </div>
                            <div class="flex flex-col space-y-2">
                                <label class="text-gray-700">ç”Ÿäº§æ‰¹æ¬¡</label>
                                <input v-model="product.batchNumber" type="text" class="form-input border p-2 rounded-md focus:outline-none" placeholder="è¯·è¾“å…¥ç”Ÿäº§æ‰¹æ¬¡å·">
                            </div>
                            <div class="flex flex-col space-y-2">
                                <label class="text-gray-700">æœ‰æœºè®¤è¯</label>
                                <select v-model="product.organic" class="form-input border p-2 rounded-md focus:outline-none">
                                    <option :value="false">å¦</option>
                                    <option :value="true">æ˜¯</option>
                                </select>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <label class="text-gray-700">è´Ÿè´£äººè”ç³»ç”µè¯</label>
                                <input v-model="product.contact" type="text" class="form-input border p-2 rounded-md focus:outline-none" placeholder="è¯·è¾“å…¥è´Ÿè´£äººè”ç³»ç”µè¯">
                            </div>
                            <div class="flex flex-col space-y-2">
                                <label class="text-gray-700">å•†å“å±•ç¤ºè§†é¢‘é“¾æ¥</label>
                                <input v-model="product.videoUrl" type="url" class="form-input border p-2 rounded-md focus:outline-none" placeholder="è¯·è¾“å…¥æˆ–ç²˜è´´å•†å“å±•ç¤ºè§†é¢‘é“¾æ¥ï¼ˆå¦‚ä¼˜é…·ã€Bç«™ã€è…¾è®¯è§†é¢‘ç­‰ï¼‰">
                            </div>
                            <div class="flex flex-col space-y-2">
                                <label class="text-gray-700">ç§æ¤åœ°ç‚¹</label>
                                <div class="flex">
                                    <input v-model="product.location" type="text" class="form-input border p-2 rounded-l-md flex-grow focus:outline-none" placeholder="è¯·è¾“å…¥ç§æ¤åœ°ç‚¹">
                                    <button @click="getLocationByIP" class="bg-green-500 text-white px-3 rounded-r-md hover:bg-green-600 transition-colors duration-300" title="è·å–å½“å‰ä½ç½®">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 11l-5-5m5 5l-5 5m5-5v12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                    </button>
                                </div>
                                <p v-if="ipLocation" class="text-xs text-gray-500 mt-1">IPå®šä½: {{ ipLocation }}</p>
                            </div>

                            <!-- å±•å¼€/æ”¶èµ·æŒ‰é’® -->
                            <div class="col-span-2 mt-2">
                                <button @click="toggleAdvancedFields" class="text-green-600 hover:text-green-800 text-sm flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path v-if="showAdvancedFields" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 11l-5-5m5 5l-5 5"></path>
                                        <path v-else stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5-5m0 0l-5 5m5-5v12"></path>
                                    </svg>
                                    {{ showAdvancedFields ? 'æ”¶èµ·é«˜çº§é€‰é¡¹' : 'å±•å¼€é«˜çº§é€‰é¡¹' }}
                                </button>
                            </div>

                            <!-- é«˜çº§å­—æ®µï¼Œå¯å±•å¼€/æ”¶èµ· -->
                            <template v-if="showAdvancedFields">
                                <div class="flex flex-col space-y-2">
                                    <label class="text-gray-700">è¥å…»æˆåˆ†</label>
                                    <div class="flex items-center">
                                        <select v-model="selectedCrop" class="form-input border p-2 rounded-md w-full focus:outline-none" @change="updateNutritionInfo">
                                            <option value="">è¯·é€‰æ‹©å†œä½œç‰©</option>
                                            <optgroup v-for="(crops, category) in cropsData" :label="category">
                                                <option v-for="(data, crop) in crops" :value="{category, crop}">{{ crop }}</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div v-if="product.nutritionInfo" class="text-xs text-gray-500 mt-1">
                                        <p>å·²è‡ªåŠ¨å¡«å……è¥å…»æˆåˆ†æ•°æ®</p>
                                    </div>
                                </div>

                                <!-- ç²¾å‡†å®šä½é€‰é¡¹ -->
                                <div class="flex flex-col space-y-2">
                                    <label class="text-gray-700">ç²¾å‡†å®šä½</label>
                                    <div class="flex items-center">
                                        <button @click="openLocationMap" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors duration-300 flex items-center">
                                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5-5m5 5l-5 5m5-5v12"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                            é€‰æ‹©ç²¾ç¡®ä½ç½®
                                        </button>
                                    </div>
                                    <div v-if="product.exactLocation" class="text-xs text-gray-500 mt-1">
                                        <p>å·²è®¾ç½®ç²¾ç¡®ä½ç½®: {{ product.exactLocation.address }}</p>
                                    </div>
                                </div>
                            </template>

                            <!-- åœ°å›¾å¼¹çª— -->
                            <div v-if="showLocationMap" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                                <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                                    <div class="p-4 border-b flex justify-between items-center">
                                        <h3 class="text-xl font-bold text-green-700">é€‰æ‹©ç²¾ç¡®ä½ç½®</h3>
                                        <button @click="closeLocationMap" class="text-gray-500 hover:text-gray-700">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="p-4 flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                                        <input id="map-address-input" type="text" class="border p-2 rounded-md flex-1" placeholder="è¯·è¾“å…¥åœ°å€ï¼Œå¦‚ï¼šæ²³å—çœå¼€å°å¸‚é¼“æ¥¼åŒº">
                                        <button id="map-search-btn" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors duration-300">å®šä½</button>
                                    </div>
                                    <div class="flex-grow overflow-hidden">
                                        <div id="location-map" class="map-container"></div>
                                    </div>
                                    <div class="p-4 border-t flex justify-between">
                                        <p class="text-xs text-gray-500">
                                            * å³é”®ç‚¹å‡»åœ°å›¾ä»»æ„ä½ç½®å¯æŸ¥çœ‹è¯¦ç»†åœ°å€ä¿¡æ¯<br>
                                            * é€‰æ‹©ä½ç½®åï¼Œå°†ä½¿ç”¨ç²¾ç¡®ä½ç½®æ›¿ä»£ä¸€èˆ¬åœ°å€
                                        </p>
                                        <button @click="confirmLocation" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors duration-300">ç¡®è®¤é€‰æ‹©</button>
                                    </div>
                                </div>
                            </div>

                            <!-- åŠ è½½çŠ¶æ€æç¤º -->
                            <div class="loading fixed inset-0 bg-white bg-opacity-80 z-[9999] justify-center items-center" id="map-loading" style="display: none;">
                                <div class="text-4xl text-green-600 animate-spin">ğŸ”</div>
                            </div>
                        </div>
                        <div class="flex justify-center mt-6 mb-2">
                            <button @click="generateQRCode"
                                :disabled="isGenerating || !product.name"
                                class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 w-full sm:w-auto text-lg"
                                :class="{'opacity-50 cursor-not-allowed': isGenerating || !product.name}">
                                <span v-if="isGenerating" class="flex items-center justify-center">
                                    <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    ç”Ÿæˆä¸­...
                                </span>
                                <span v-else>ç”Ÿæˆæº¯æºç </span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æº¯æºç å±•ç¤ºéƒ¨åˆ† -->
                <!-- éšè—çš„äºŒç»´ç å®¹å™¨ï¼Œç”¨äºç”ŸæˆäºŒç»´ç  -->
                <div id="qrcode-container" style="display: none;"></div>

                <div v-if="qrCode" class="bg-white rounded-lg shadow-md p-4 sm:p-8 fade-in">
                    <h2 class="text-2xl font-bold text-center text-green-700 mb-4 sm:mb-6">æº¯æºç ä¿¡æ¯</h2>
                    <div class="flex flex-col md:flex-row items-center md:items-start md:space-x-8 space-y-4 md:space-y-0">
                        <div class="qrcode-container">
                            <img :src="qrCode" alt="æº¯æºç " class="w-full h-full object-contain">
                        </div>
                        <div class="flex-1">
                            <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500 mb-4">
                                <h3 class="text-lg font-semibold text-green-700 mb-2">äº§å“åŸºæœ¬ä¿¡æ¯</h3>
                                <div class="space-y-2">
                                    <p><span class="font-medium text-gray-600">äº§å“åç§°:</span> <span class="text-gray-800">{{ product.name }}</span></p>
                                    <p v-if="product.location"><span class="font-medium text-gray-600">ç§æ¤åœ°ç‚¹:</span> <span class="text-gray-800">{{ product.location }}</span></p>
                                </div>
                            </div>

                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 mb-4">
                                <h3 class="text-lg font-semibold text-blue-700 mb-2">æ—¶é—´ä¿¡æ¯</h3>
                                <div class="space-y-2">
                                    <p v-if="product.plantingDate"><span class="font-medium text-gray-600">ç§æ¤æ—¶é—´:</span> <span class="text-gray-800">{{ formatDate(product.plantingDate) }}</span></p>
                                    <p v-if="product.harvestDate"><span class="font-medium text-gray-600">æ”¶è·æ—¶é—´:</span> <span class="text-gray-800">{{ formatDate(product.harvestDate) }}</span></p>
                                </div>
                            </div>

                            <div v-if="product.fertilizer" class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500 mb-4">
                                <h3 class="text-lg font-semibold text-yellow-700 mb-2">æ–½è‚¥è®°å½•</h3>
                                <p class="text-gray-700 whitespace-pre-line">{{ product.fertilizer }}</p>
                            </div>

                            <div v-if="product.pesticide" class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                                <h3 class="text-lg font-semibold text-red-700 mb-2">å†œè¯ä½¿ç”¨</h3>
                                <p class="text-gray-700 whitespace-pre-line">{{ product.pesticide }}</p>
                            </div>
                            <div v-if="product.number" class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500">
                                <h3 class="text-lg font-semibold text-purple-700 mb-2">ç”µè¯å·ç </h3>
                                <p class="text-gray-700 whitespace-pre-line">{{ product.number }}</p>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-500 mb-2">æ‰«æä¸Šæ–¹äºŒç»´ç æŸ¥çœ‹è¯¦ç»†æº¯æºä¿¡æ¯</p>
                        <button @click="resetForm" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors duration-300 mr-2">
                            é‡æ–°ç”Ÿæˆ
                        </button>
                        <button @click="downloadQRCode" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors duration-300 mr-2">
                            <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            ä¸‹è½½äºŒç»´ç 
                        </button>
                        <a :href="detailPageUrl" target="_blank" class="inline-block bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors duration-300">
                            æŸ¥çœ‹è¯¦æƒ…é¡µ
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡µè„š -->
        <footer class="bg-green-800 text-white p-8 mt-8 rounded-lg">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold">æ™ºæ…§å†œåœºæº¯æºç³»ç»Ÿ</h3>
                        <p>ç§‘æŠ€èµ‹èƒ½å†œä¸šï¼Œæ™ºæ…§åˆ›é€ æœªæ¥</p>
                    </div>
                    <div class="mt-4 md:mt-0">
                        <p>å…¬å¸ç½‘ç«™: <a href="http://www.hl3344.space" target="_blank" class="underline">www.hl3344.space</a></p>
                        <p>è”ç³»ç”µè¯: 1862483344</p>
                    </div>
                </div>
                <div class="mt-8 text-center">
                    <p>Â© 2025 æ™ºæ…§å†œåœºæº¯æºç³»ç»Ÿ. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- å¼•å…¥é«˜å¾·åœ°å›¾API -->
    <script src="https://webapi.amap.com/loader.js"></script>
    <script>
        // é«˜å¾·åœ°å›¾é…ç½®
        window._AMapSecurityConfig = {
            securityJsCode: 'd923255fe176efb202c35546cbc00a53' // å®‰å…¨å¯†é’¥
        };

        new Vue({
            el: '#app',
            data: {
                baseUrl: location.origin, // è‡ªåŠ¨è·å–å½“å‰åŸŸå
                apiBaseUrl: 'http://localhost:3001', // è®¾ç½®APIæœåŠ¡å™¨åœ°å€
                showLocationMap: false, // æ§åˆ¶åœ°å›¾å¼¹çª—æ˜¾ç¤º
                locationMap: null, // åœ°å›¾å®ä¾‹
                locationMarker: null, // åœ°å›¾æ ‡è®°
                locationGeocoder: null, // åœ°ç†ç¼–ç å™¨
                locationInfoWindow: null, // ä¿¡æ¯çª—å£
                selectedLocation: null, // é€‰ä¸­çš„ä½ç½®
                product: {
                    name: '',
                    location: '',
                    plantingDate: '',
                    exactLocation: null, // ç²¾ç¡®ä½ç½®ä¿¡æ¯ï¼ŒåŒ…å«ç»çº¬åº¦å’Œåœ°å€
                    batchNumber: '',
                    certification: '',
                    organic: false,
                    storageMethod: '',
                    nutritionInfo: '',
                    harvestDate: '',
                    fertilizer: '',
                    pesticide: '',
                    companyName: '',
                    contact: ''
                },
                qrCode: '',
                batchCodes: [],
                isGenerating: false,
                detailPageUrl: '',
                pageUrl:'',
                qrCodeInstance: null,
                showAdvancedFields: false,
                cropsData: null,
                selectedCrop: '',
                ipLocation: '',
                ipToken: 'ff142509a16cf4', // IPä¿¡æ¯APIçš„token
                uploadStatus: {
                    loading: false,
                    message: '',
                    success: false,
                    error: false
                }
            },
            mounted() {
                // åŠ è½½å†œä½œç‰©è¥å…»æˆåˆ†æ•°æ®
                this.loadCropsData();
            },
            methods: {
                // åŠ è½½å†œä½œç‰©è¥å…»æˆåˆ†æ•°æ®
                async loadCropsData() {
                    try {
                        const response = await fetch('crops_nutrition.json');
                        if (!response.ok) {
                            throw new Error('æ— æ³•åŠ è½½å†œä½œç‰©æ•°æ®');
                        }
                        this.cropsData = await response.json();
                        console.log('åŠ è½½å†œä½œç‰©æ•°æ®æˆåŠŸ', this.cropsData);
                    } catch (error) {
                        console.error('åŠ è½½å†œä½œç‰©æ•°æ®å¤±è´¥:', error);
                    }
                },

                // æ ¹æ®é€‰æ‹©çš„å†œä½œç‰©æ›´æ–°è¥å…»æˆåˆ†ä¿¡æ¯
                updateNutritionInfo() {
                    if (!this.selectedCrop || !this.cropsData) return;

                    const { category, crop } = this.selectedCrop;
                    if (this.cropsData[category] && this.cropsData[category][crop]) {
                        // åªå­˜å‚¨è¥å…»æˆåˆ†çš„æ•°å€¼æ•°ç»„ï¼ŒæŒ‰å›ºå®šé¡ºåºæ’åˆ—
                        const nutritionData = this.cropsData[category][crop];
                        // ç¡®ä¿æŒ‰ç…§å›ºå®šé¡ºåºæå–æ•°å€¼ï¼šè›‹ç™½è´¨ã€è„‚è‚ªã€ç¢³æ°´åŒ–åˆç‰©ã€è†³é£Ÿçº¤ç»´ã€ç»´ç”Ÿç´ Cã€é’™ã€é“
                        const nutritionOrder = ['è›‹ç™½è´¨', 'è„‚è‚ª', 'ç¢³æ°´åŒ–åˆç‰©', 'è†³é£Ÿçº¤ç»´', 'ç»´ç”Ÿç´ C', 'é’™', 'é“'];
                        const nutritionValues = nutritionOrder.map(key => nutritionData[key] || 0);

                        // å°†æ•°å€¼æ•°ç»„è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²å­˜å‚¨
                        this.product.nutritionInfo = JSON.stringify(nutritionValues);
                        console.log('å·²æ›´æ–°è¥å…»æˆåˆ†æ•°æ®ï¼ˆä»…æ•°å€¼ï¼‰', this.product.nutritionInfo);
                    }
                },

                // åˆ‡æ¢æ˜¾ç¤º/éšè—é«˜çº§å­—æ®µ
                toggleAdvancedFields() {
                    this.showAdvancedFields = !this.showAdvancedFields;
                },

                // ä½¿ç”¨IPè·å–ä½ç½®ä¿¡æ¯
                getLocationByIP() {
                    fetch(`http://ipinfo.io/json?token=${this.ipToken}`)
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            } else {
                                throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                            }
                        })
                        .then(data => {
                            this.ipLocation = `${data.city}, ${data.region}, ${data.country}`;
                            if (!this.product.location) {
                                this.product.location = this.ipLocation;
                            }
                        })
                        .catch(error => {
                            console.error('è·å–IPä¿¡æ¯å¤±è´¥:', error);
                            alert('æ— æ³•è·å–ä½ç½®ä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥');
                        });
                },

                async generateQRCode() {
                    console.log('Generating QR code...');
                    if (!this.product.name) {
                        alert('è¯·è¾“å…¥äº§å“åç§°');
                        return;
                    }
                    try {
                        this.isGenerating = true;

                        // å‡†å¤‡è¥å…»æˆåˆ†æ•°æ® - ç›´æ¥ä½¿ç”¨å·²å­˜å‚¨çš„æ•°å€¼æ•°ç»„
                        let nutritionValues = [];
                        if (this.product.nutritionInfo) {
                            try {
                                // ç›´æ¥ä½¿ç”¨å·²ç»æŒ‰å›ºå®šé¡ºåºå­˜å‚¨çš„æ•°å€¼æ•°ç»„
                                nutritionValues = JSON.parse(this.product.nutritionInfo);
                            } catch (e) {
                                console.error('è§£æè¥å…»æˆåˆ†æ•°æ®å¤±è´¥:', e);
                            }
                        }

                        // å‡†å¤‡äº§å“æ•°æ®ï¼Œå¦‚æœæœ‰ç²¾ç¡®ä½ç½®åˆ™ä½¿ç”¨ç²¾ç¡®ä½ç½®æ›¿ä»£ä¸€èˆ¬åœ°å€
                        const productData = {
                            productName: this.product.name,
                            plantingDate: this.product.plantingDate,
                            harvestDate: this.product.harvestDate,
                            batchNumber: this.product.batchNumber,
                            contact: this.product.contact || '1862483344',
                            nutritionValues: nutritionValues,
                            companyWebsite: 'http://www.hl3344.space',
                            videoUrl: this.product.videoUrl || ''
                        };

                        // å¦‚æœè®¾ç½®äº†ç²¾ç¡®ä½ç½®ï¼Œåˆ™ä½¿ç”¨ç²¾ç¡®ä½ç½®ä¿¡æ¯
                        if (this.product.exactLocation) {
                            // ä¼˜åŒ–åçš„ç²¾ç¡®ä½ç½®æ•°æ®
                            productData.exactLocation = {
                                longitude: this.product.exactLocation.longitude,
                                latitude: this.product.exactLocation.latitude,
                                address: this.product.exactLocation.address,
                                region: this.product.exactLocation.region,
                                city: this.product.exactLocation.city,
                                district: this.product.exactLocation.district
                            };
                            // ä¸ä¼ é€’æ™®é€šåœ°å€ï¼Œåªä½¿ç”¨ç²¾ç¡®åœ°å€
                        } else {
                            // æ²¡æœ‰ç²¾ç¡®ä½ç½®ï¼Œä½¿ç”¨æ™®é€šåœ°å€
                            productData.location = this.product.location;
                        }

                        console.log('Product Data:', productData);
                        const encodedData = encodeURIComponent(JSON.stringify(productData));
                        this.detailPageUrl = `${this.baseUrl}/product-detail.html?data=${encodedData}`;
                        this.pageUrl= `/product-detail.html?data=${encodedData}`;

                        // ä¿å­˜äºŒç»´ç æ•°æ®åˆ°æœåŠ¡å™¨
                        try {
                            console.log('å‡†å¤‡å‘é€æ•°æ®åˆ°æœåŠ¡å™¨...');
                            const requestData = {
                                productData: {
                                    url: this.pageUrl,
                                    name: this.product.name
                                }
                            };
                            console.log('è¯·æ±‚æ•°æ®:', JSON.stringify(requestData));

                            // è®¾ç½®APIåŸºç¡€URLï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æœåŠ¡å™¨åœ°å€
                            const apiBaseUrl = 'http://localhost:3001';
                            console.log('ä½¿ç”¨APIåŸºç¡€åœ°å€:', apiBaseUrl);

                            // ä¿®å¤ï¼šä½¿ç”¨å®Œæ•´çš„ç»å¯¹URLï¼Œå¹¶æ·»åŠ é‡è¯•æœºåˆ¶
                            let retryCount = 0;
                            const maxRetries = 3;
                            let response;

                            while (retryCount < maxRetries) {
                                try {
                                    // ä½¿ç”¨Vueå®ä¾‹ä¸­å®šä¹‰çš„APIåŸºç¡€URL
                                    const apiUrl = `${this.apiBaseUrl}/api/add-product`;
                                    console.log('ä½¿ç”¨APIåœ°å€:', apiUrl);

                                    response = await fetch(apiUrl, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Accept': 'application/json'
                                        },
                                        body: JSON.stringify(requestData)
                                    });

                                    console.log('æœåŠ¡å™¨å“åº”çŠ¶æ€:', response.status);

                                    // å¦‚æœæˆåŠŸï¼Œè·³å‡ºé‡è¯•å¾ªç¯
                                    if (response.ok) break;

                                    // å¦‚æœä»ç„¶å¤±è´¥ï¼Œè®°å½•é”™è¯¯å¹¶é‡è¯•
                                    console.error(`APIè¯·æ±‚å¤±è´¥(${response.status}): ${response.statusText}`);
                                    retryCount++;

                                    // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                                    await new Promise(resolve => setTimeout(resolve, 1000));
                                    continue;

                                    throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status} ${response.statusText}`);
                                } catch (fetchError) {
                                    console.error(`ç¬¬${retryCount + 1}æ¬¡è¯·æ±‚å¤±è´¥:`, fetchError);
                                    retryCount++;

                                    // æœ€åä¸€æ¬¡é‡è¯•å¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯
                                    if (retryCount >= maxRetries) {
                                        throw fetchError;
                                    }

                                    // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                                    await new Promise(resolve => setTimeout(resolve, 1000));
                                }
                            }

                            // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
                            if (!response.ok) {
                                console.error(`APIå“åº”é”™è¯¯: çŠ¶æ€ç =${response.status}, çŠ¶æ€æ–‡æœ¬=${response.statusText}`);
                                throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status} ${response.statusText}`);
                            }

                            console.log('APIè¯·æ±‚æˆåŠŸï¼ŒçŠ¶æ€ç :', response.status);

                            // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                            const contentType = response.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                throw new Error(`æœåŠ¡å™¨å“åº”ä¸æ˜¯JSONæ ¼å¼: ${contentType}`);
                            }

                            // è·å–å“åº”æ–‡æœ¬ç”¨äºè°ƒè¯•
                            const responseText = await response.text();
                            console.log('æœåŠ¡å™¨å“åº”åŸå§‹æ–‡æœ¬:', responseText);

                            // å°è¯•è§£æJSON
                            let result;
                            try {
                                result = JSON.parse(responseText);
                            } catch (parseError) {
                                throw new Error(`è§£ææœåŠ¡å™¨å“åº”JSONå¤±è´¥: ${parseError.message}, åŸå§‹å“åº”: ${responseText}`);
                            }

                            console.log('æœåŠ¡å™¨å“åº”æ•°æ®:', result);

                            if (result.success) {
                                console.log('äºŒç»´ç æ•°æ®å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼Œäº§å“ID:', result.productId);
                                console.log('å‘¨æ ‡è¯†:', result.weekKey);
                                // æ›´æ–°äºŒç»´ç é“¾æ¥ï¼Œä½¿ç”¨p.htmlé‡å®šå‘é¡µé¢
                                this.detailPageUrl = `${this.baseUrl}/p.html?id=${result.productId}`;
                                console.log('æ›´æ–°åçš„äºŒç»´ç é“¾æ¥:', this.detailPageUrl);

                                // å°†å•ä¸ªäºŒç»´ç æ•°æ®å†™å…¥qrcodes.json
                                this.writeToQrcodesJson({
                                    code: this.detailPageUrl,
                                    name: this.product.name,
                                    data: productData
                                });
                            } else {
                                console.error('ä¿å­˜äºŒç»´ç æ•°æ®å¤±è´¥:', result.error);
                            }
                        } catch (error) {
                            console.error('ä¿å­˜äºŒç»´ç æ•°æ®åˆ°æœåŠ¡å™¨å‡ºé”™:', error);
                            alert(`ä¿å­˜äºŒç»´ç æ•°æ®å¤±è´¥: ${error.message}`);
                        }

                        // ä¿®æ”¹1: ç¡®ä¿å®¹å™¨å­˜åœ¨ä¸”æ¸…ç©º
                        const qrcodeContainer = document.getElementById('qrcode-container');
                        if (!qrcodeContainer) {
                            throw new Error('æ— æ³•æ‰¾åˆ°äºŒç»´ç å®¹å™¨å…ƒç´ ');
                        }
                        qrcodeContainer.innerHTML = '';

                        // ä¿®æ”¹2: ä½¿ç”¨Promiseç¡®ä¿äºŒç»´ç ç”Ÿæˆå®Œæˆ
                        await new Promise((resolve) => {
                            // åˆ›å»ºä¸€ä¸ªImageå¯¹è±¡ç”¨äºlogo
                            const logoImage = new Image();
                            logoImage.crossOrigin = 'Anonymous'; // è§£å†³è·¨åŸŸé—®é¢˜
                            logoImage.src = './logo.png'; // å‡è®¾ logo.png ä¸å½“å‰æ–‡ä»¶åŒçº§

                            // ç­‰å¾…logoå›¾ç‰‡åŠ è½½å®Œæˆ
                            logoImage.onload = () => {
                                this.qrCodeInstance = new QRCode(qrcodeContainer, {
                                    text: this.detailPageUrl,
                                    width: 200,
                                    height: 200,
                                    colorDark: '#000000',
                                    colorLight: '#ffffff',
                                    correctLevel: QRCode.CorrectLevel.H
                                });

                                // ç»™äºŒç»´ç ç”Ÿæˆä¸€ç‚¹æ—¶é—´
                                setTimeout(() => {
                                    // è·å–ç”Ÿæˆçš„äºŒç»´ç å›¾ç‰‡
                                    const qrCanvas = qrcodeContainer.querySelector('canvas');
                                    if (qrCanvas) {
                                        // è·å–canvasä¸Šä¸‹æ–‡
                                        const ctx = qrCanvas.getContext('2d');

                                        // è®¡ç®—logoçš„ä½ç½®å’Œå¤§å°ï¼ˆå±…ä¸­ï¼Œå¤§å°ä¸ºäºŒç»´ç çš„1/5ï¼‰
                                        const logoSize = qrCanvas.width / 5;
                                        const logoX = (qrCanvas.width - logoSize) / 2;
                                        const logoY = (qrCanvas.height - logoSize) / 2;

                                        // å…ˆç»˜åˆ¶ç™½è‰²èƒŒæ™¯ï¼ˆå¯é€‰ï¼‰
                                        ctx.fillStyle = '#FFFFFF';
                                        ctx.fillRect(logoX - 2, logoY - 2, logoSize + 4, logoSize + 4);

                                        // ç»˜åˆ¶logo
                                        ctx.drawImage(logoImage, logoX, logoY, logoSize, logoSize);

                                        // æ›´æ–°äºŒç»´ç å›¾ç‰‡
                                        const qrImg = qrcodeContainer.querySelector('img');
                                        if (qrImg) {
                                            qrImg.src = qrCanvas.toDataURL();
                                        }
                                    }
                                    resolve();
                                }, 100);
                            };

                            // å¤„ç†logoåŠ è½½å¤±è´¥çš„æƒ…å†µ
                            logoImage.onerror = () => {
                                console.error('LogoåŠ è½½å¤±è´¥');
                                this.qrCodeInstance = new QRCode(qrcodeContainer, {
                                    text: this.detailPageUrl,
                                    width: 200,
                                    height: 200,
                                    colorDark: '#000000',
                                    colorLight: '#ffffff',
                                    correctLevel: QRCode.CorrectLevel.H
                                });
                                setTimeout(resolve, 100);
                            };
                        });

                        // ä¿®æ”¹3: ç›´æ¥ä½¿ç”¨äºŒç»´ç å®ä¾‹çš„_imgå±æ€§è·å–å›¾ç‰‡
                        if (this.qrCodeInstance && this.qrCodeInstance._el) {
                            const qrImage = this.qrCodeInstance._el.querySelector('img');
                            if (qrImage) {
                                console.log('QR Code img:', qrImage.src);
                                this.qrCode = qrImage.src;
                            } else {
                                throw new Error('äºŒç»´ç å›¾ç‰‡ç”Ÿæˆå¤±è´¥');
                            }
                        } else {
                            throw new Error('äºŒç»´ç å®ä¾‹åˆ›å»ºå¤±è´¥');
                        }
                    } catch (error) {
                        console.error('ç”ŸæˆäºŒç»´ç å‡ºé”™:', error);
                        alert(`ç”ŸæˆäºŒç»´ç å‡ºé”™: ${error.message}`);
                        this.qrCode = null;
                    } finally {
                        this.isGenerating = false;
                    }
                },

                // æ–°å¢æ‰¹é‡å¤„ç†æ–¹æ³•
                handleExcelUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
                    this.uploadStatus = {
                        loading: true,
                        message: 'æ­£åœ¨è§£æExcelæ–‡ä»¶...',
                        success: false,
                        error: false
                    };

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                            if (!jsonData.length) {
                                throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®');
                            }

                            // æ£€æŸ¥å¿…è¦å­—æ®µ
                            const requiredFields = ['äº§å“åç§°'];
                            const missingFields = requiredFields.filter(field =>
                                !jsonData.some(item => item[field] !== undefined)
                            );

                            if (missingFields.length > 0) {
                                throw new Error(`Excelæ–‡ä»¶ç¼ºå°‘å¿…è¦å­—æ®µ: ${missingFields.join(', ')}`);
                            }

                            // å¤„ç†æ•°æ®
                            this.batchCodes = jsonData.map((item, index) => {
                                // ä¸ºæ¯ä¸ªäº§å“ç”Ÿæˆè¯¦æƒ…é¡µURL
                                const productData = {
                                    productName: item.äº§å“åç§° || 'æœªå‘½å',
                                    location: item.ç§æ¤åœ°ç‚¹ || '',
                                    plantingDate: item.ç§æ¤æ—¶é—´ || '',
                                    harvestDate: item.æ”¶è·æ—¶é—´ || '',
                                    batchNumber: item.ç”Ÿäº§æ‰¹æ¬¡ || '',
                                    contact: item.è”ç³»ç”µè¯ || '1862483344',
                                    companyWebsite: 'http://www.hl3344.space'
                                };

                                const encodedData = encodeURIComponent(JSON.stringify(productData));
                                const detailUrl = `${this.baseUrl}/product-detail.html?data=${encodedData}`;

                                return {
                                    code: detailUrl,
                                    name: item.äº§å“åç§° || `äº§å“${index+1}`,
                                    data: productData
                                };
                            });

                            // æ›´æ–°ä¸Šä¼ çŠ¶æ€
                            this.uploadStatus = {
                                loading: false,
                                message: `æˆåŠŸè§£æ ${this.batchCodes.length} æ¡äº§å“æ•°æ®`,
                                success: true,
                                error: false,
                                count: this.batchCodes.length
                            };

                        } catch (error) {
                            console.error('Excelè§£æå¤±è´¥:', error);
                            this.uploadStatus = {
                                loading: false,
                                message: `æ–‡ä»¶è§£æå¤±è´¥: ${error.message}`,
                                success: false,
                                error: true
                            };
                        }
                    };
                    reader.readAsArrayBuffer(file);
                },

                async downloadBatchQRCodes() {
                    if (!this.batchCodes.length) return;

                    try {
                        const zip = new JSZip();
                        const imgFolder = zip.folder('qrcodes');

                        // åŠ è½½logoå›¾ç‰‡
                        const logoImage = new Image();
                        logoImage.crossOrigin = 'Anonymous'; // è§£å†³è·¨åŸŸé—®é¢˜
                        logoImage.src = './logo.png'; // å‡è®¾ logo.png ä¸å½“å‰æ–‡ä»¶åŒçº§

                        // ç­‰å¾…logoåŠ è½½å®Œæˆ
                        await new Promise((resolve, reject) => {
                            logoImage.onload = resolve;
                            logoImage.onerror = () => {
                                console.error('LogoåŠ è½½å¤±è´¥');
                                resolve(); // å³ä½¿logoåŠ è½½å¤±è´¥ä¹Ÿç»§ç»­
                            };
                        });

                        // å­˜å‚¨æ‰€æœ‰æ‰¹é‡äºŒç»´ç æ•°æ®ï¼Œç”¨äºå†™å…¥qrcodes.json
                        const batchQrcodesData = [];

                        // ä½¿ç”¨æœ¬åœ°äºŒç»´ç ç”Ÿæˆé€»è¾‘ï¼Œä¸ä¾èµ–å¤–éƒ¨æœåŠ¡
                        await Promise.all(this.batchCodes.map(async (item, index) => {
                            // åˆ›å»ºä¸´æ—¶å®¹å™¨ç”ŸæˆäºŒç»´ç 
                            const tempContainer = document.createElement('div');
                            document.body.appendChild(tempContainer);

                            // ä¿å­˜äºŒç»´ç ä¿¡æ¯åˆ°åç«¯
                            const saveResult = await this.saveBatchToServer(item);
                            if (!saveResult.success) {
                                throw new Error(`ä¿å­˜äºŒç»´ç æ•°æ®å¤±è´¥: ${saveResult.message}`);
                            }

                            // ä½¿ç”¨é‡å®šå‘URLæ›´æ–°äºŒç»´ç ä¿¡æ¯
                            const redirectUrl = `${this.baseUrl}/p.html?id=${saveResult.productId}`;
                            const simpleUrl=`/p.html?id=${saveResult.productId}`;
                            batchQrcodesData.push({
                                code: simpleUrl,
                                name: item.name,
                                data: item.data,
                                id: saveResult.productId
                            });

                            // æ›´æ–°äºŒç»´ç çš„URLä¸ºé‡å®šå‘URL
                            item.code = redirectUrl;

                            // ç”ŸæˆäºŒç»´ç 
                            const qrcode = new QRCode(tempContainer, {
                                text: redirectUrl,
                                width: 300,
                                height: 300,
                                colorDark: '#000000',
                                colorLight: '#ffffff',
                                correctLevel: QRCode.CorrectLevel.H
                            });

                            // æ·»åŠ logoåˆ°äºŒç»´ç ä¸­å¿ƒ
                            const qrCanvas = tempContainer.querySelector('canvas');
                            if (qrCanvas && logoImage.complete) {
                                const ctx = qrCanvas.getContext('2d');

                                // è®¡ç®—logoçš„ä½ç½®å’Œå¤§å°ï¼ˆå±…ä¸­ï¼Œå¤§å°ä¸ºäºŒç»´ç çš„1/5ï¼‰
                                const logoSize = qrCanvas.width / 5;
                                const logoX = (qrCanvas.width - logoSize) / 2;
                                const logoY = (qrCanvas.height - logoSize) / 2;

                                // å…ˆç»˜åˆ¶ç™½è‰²èƒŒæ™¯
                                ctx.fillStyle = '#FFFFFF';
                                ctx.fillRect(logoX - 2, logoY - 2, logoSize + 4, logoSize + 4);

                                // ç»˜åˆ¶logo
                                ctx.drawImage(logoImage, logoX, logoY, logoSize, logoSize);
                            }

                            // å°†Canvasè½¬æ¢ä¸ºBlob
                            const blob = await new Promise((resolve) => {
                                qrCanvas.toBlob(resolve, 'image/png');
                            });

                            // å°†äºŒç»´ç å›¾ç‰‡æ·»åŠ åˆ°å‹ç¼©åŒ…
                            imgFolder.file(`${item.name}.png`, blob);

                            // æ¸…ç†ä¸´æ—¶å®¹å™¨
                            document.body.removeChild(tempContainer);
                        }));

                        // å°†æ‰€æœ‰æ‰¹é‡äºŒç»´ç æ•°æ®å†™å…¥qrcodes.json
                        this.writeBatchToQrcodesJson(batchQrcodesData);

                        // ç”Ÿæˆå‹ç¼©åŒ…å¹¶ä¸‹è½½
                        const content = await zip.generateAsync({type: 'blob'});
                        const url = window.URL.createObjectURL(content);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'qrcodes.zip';
                        a.click();
                        window.URL.revokeObjectURL(url);

                        // æ›´æ–°çŠ¶æ€ä¸ºæˆåŠŸ
                        this.uploadStatus = {
                            loading: false,
                            message: `æˆåŠŸç”Ÿæˆ ${this.batchCodes.length} ä¸ªäºŒç»´ç `,
                            success: true,
                            error: false
                        };

                    } catch (error) {
                        console.error('æ‰“åŒ…ä¸‹è½½å¤±è´¥:', error);
                        this.uploadStatus = {
                            loading: false,
                            message: 'äºŒç»´ç æ‰“åŒ…å¤±è´¥ï¼Œè¯·é‡è¯•',
                            success: false,
                            error: true
                        };
                    }
                },

                // å°†äºŒç»´ç æ•°æ®ä¿å­˜åˆ°åç«¯æ¥å£
                async saveBatchToServer(item) {
                    try {
                        const productData = {
                            productName: item.data.productName,
                            plantingDate: item.data.plantingDate,
                            harvestDate: item.data.harvestDate,
                            batchNumber: item.data.batchNumber,
                            contact: item.data.contact,
                            nutritionValues: item.data.nutritionValues || [],
                            companyWebsite: item.data.companyWebsite,
                            videoUrl: item.data.videoUrl || '',
                        };

                        if (item.data.exactLocation) {
                            productData.exactLocation = {
                                longitude: item.data.exactLocation.longitude,
                                latitude: item.data.exactLocation.latitude,
                                address: item.data.exactLocation.address,
                                region: item.data.exactLocation.region,
                                city: item.data.exactLocation.city,
                                district: item.data.exactLocation.district
                            };
                        } else {
                            productData.location = item.data.location;
                        }

                        const encodedData = encodeURIComponent(JSON.stringify(productData));
                        const detailUrl = `${this.baseUrl}/product-detail.html?data=${encodedData}`;
                        const simpleUrl=`/product-detail.html?data=${encodedData}`
                        const requestData = {
                            productData: {
                                url: simpleUrl,
                                name: item.name
                            }
                        };

                        const apiUrl = `${this.apiBaseUrl}/api/add-product`;
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });

                        if (!response.ok) {
                            throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status} ${response.statusText}`);
                        }

                        const result = await response.json();
                        if (result.success) {
                            console.log('äºŒç»´ç æ•°æ®å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼Œäº§å“ID:', result.productId);
                            return {
                                success: true,
                                productId: result.productId,
                                weekKey: result.weekKey
                            };
                        } else {
                            throw new Error('ä¿å­˜äºŒç»´ç æ•°æ®å¤±è´¥:' + result.error);
                        }
                    } catch (error) {
                        console.error('ä¿å­˜æ‰¹é‡äºŒç»´ç æ•°æ®å¤±è´¥:', error);
                        return {
                            success: false,
                            message: error.message
                        };
                    }
                },

                // å°†æ‰¹é‡äºŒç»´ç æ•°æ®å†™å…¥qrcodes.json
                writeBatchToQrcodesJson(data) {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰qrcodes.jsonæ–‡ä»¶çš„æ•°æ®
                    let existingData = [];
                    try {
                        const existingJson = localStorage.getItem('qrcodes');
                        if (existingJson) {
                            existingData = JSON.parse(existingJson);
                        }
                    } catch (error) {
                        console.error('è¯»å–ç°æœ‰qrcodes.jsonæ•°æ®å¤±è´¥:', error);
                    }

                    // å¦‚æœæ˜¯æ•°ç»„ï¼Œåˆ™åˆå¹¶æ•°æ®ï¼›å¦åˆ™åˆ›å»ºæ–°æ•°ç»„
                    if (Array.isArray(existingData)) {
                        existingData = [...existingData, ...data];
                    } else {
                        existingData = data;
                    }

                    // å°†æ›´æ–°åçš„æ•°æ®ä¿å­˜å›localStorage
                    try {
                        localStorage.setItem('qrcodes', JSON.stringify(existingData));
                        console.log('å·²æ›´æ–°qrcodes.jsonæ•°æ®:', existingData);
                    } catch (error) {
                        console.error('ä¿å­˜qrcodes.jsonæ•°æ®å¤±è´¥:', error);
                    }
                },

                // å°†å•ä¸ªäºŒç»´ç æ•°æ®å†™å…¥qrcodes.json
                writeToQrcodesJson(data) {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰qrcodes.jsonæ–‡ä»¶çš„æ•°æ®
                    let existingData = [];
                    try {
                        const existingJson = localStorage.getItem('qrcodes');
                        if (existingJson) {
                            existingData = JSON.parse(existingJson);
                        }
                    } catch (error) {
                        console.error('è¯»å–ç°æœ‰qrcodes.jsonæ•°æ®å¤±è´¥:', error);
                    }

                    // å¦‚æœæ˜¯æ•°ç»„ï¼Œåˆ™åˆå¹¶æ•°æ®ï¼›å¦åˆ™åˆ›å»ºæ–°æ•°ç»„
                    if (Array.isArray(existingData)) {
                        existingData.push(data);
                    } else {
                        existingData = [data];
                    }

                    // å°†æ›´æ–°åçš„æ•°æ®ä¿å­˜å›localStorage
                    try {
                        localStorage.setItem('qrcodes', JSON.stringify(existingData));
                        console.log('å·²æ›´æ–°qrcodes.jsonæ•°æ®:', existingData);
                    } catch (error) {
                        console.error('ä¿å­˜qrcodes.jsonæ•°æ®å¤±è´¥:', error);
                    }
                },

                resetForm() {
                    this.qrCode = null;
                },

                downloadQRCode() {
                    if (!this.qrCode) return;

                    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶é“¾æ¥å…ƒç´ 
                    const a = document.createElement('a');
                    a.href = this.qrCode;
                    a.download = `${this.product.name || 'å†œäº§å“'}_æº¯æºç .png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                },

                formatDate(dateString) {
                    if (!dateString) return 'æœªè®¾ç½®';

                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return dateString;

                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                },

                // ç²¾å‡†å®šä½ç›¸å…³æ–¹æ³•
                openLocationMap() {
                    this.showLocationMap = true;
                    // å»¶è¿Ÿåˆå§‹åŒ–åœ°å›¾ï¼Œç¡®ä¿DOMå·²ç»æ¸²æŸ“
                    this.$nextTick(() => {
                        this.initLocationMap();
                    });
                },

                closeLocationMap() {
                    this.showLocationMap = false;
                },

                initLocationMap() {
                    // åˆå§‹åŒ–åœ°å›¾
                    if (!this.locationMap) {
                        AMapLoader.load({
                            key: "5ad852daa54b2ec5cc25ea383499b9b3", // æ›¿æ¢ä¸ºæ‚¨çš„ key
                            version: "2.0", // æŒ‡å®šè¦åŠ è½½çš„ JS API çš„ç‰ˆæœ¬
                            plugins: ["AMap.Geocoder", "AMap.Marker"] // éœ€è¦ä½¿ç”¨çš„æ’ä»¶åˆ—è¡¨
                        })
                        .then(AMap => {
                            this.locationMap = new AMap.Map("location-map", {
                                resizeEnable: true,
                                center: [114.3519, 34.7991], // é»˜è®¤å¼€å°å¸‚
                                zoom: 12
                            });

                            // åˆå§‹åŒ–åœ°ç†ç¼–ç å™¨
                            this.locationGeocoder = new AMap.Geocoder({
                                city: "410200", // å¼€å°å¸‚è¡Œæ”¿åŒºåˆ’ä»£ç 
                                radius: 1000
                            });

                            // ç§»é™¤é»˜è®¤çš„å³é”®èœå•
                            this.locationMap.off('rightclick');

                            // åœ°å›¾å³é”®ç‚¹å‡»äº‹ä»¶
                            this.locationMap.on('rightclick', (e) => {
                                this.showMapLoading(true);

                                this.locationGeocoder.getAddress(e.lnglat, (status, result) => {
                                    this.showMapLoading(false);

                                    if (status === 'complete' && result.regeocode) {
                                        const address = result.regeocode.formattedAddress;
                                        const info = result.regeocode.addressComponent;

                                        const content = `
                                            <div class="p-2 bg-white rounded shadow info-window">
                                                <p><strong>å®Œæ•´åœ°å€ï¼š</strong>${address}</p>
                                                <p><strong>çœä»½ï¼š</strong>${info.province}</p>
                                                <p><strong>åŸå¸‚ï¼š</strong>${info.city}</p>
                                                <p><strong>åŒºå¿ï¼š</strong>${info.district}</p>
                                                <p><strong>ä¹¡é•‡ï¼š</strong>${info.township}</p>
                                                <p><strong>è¯¦ç»†åœ°å€ï¼š</strong>${info.street + info.streetNumber}</p>
                                            </div>
                                        `;

                                        if (this.locationInfoWindow) {
                                            this.locationInfoWindow.setContent(content);
                                            this.locationInfoWindow.setPosition(e.lnglat);
                                            this.locationInfoWindow.open(this.locationMap);
                                        } else {
                                            this.locationInfoWindow = new AMap.InfoWindow({
                                                content: content,
                                                position: e.lnglat
                                            });
                                            this.locationInfoWindow.open(this.locationMap);
                                        }

                                        this.updateLocationMarker(e.lnglat);
                                        this.selectedLocation = {
                                            lnglat: e.lnglat,
                                            address: address,
                                            info: info
                                        };
                                    } else {
                                        alert('è·å–åœ°å€ä¿¡æ¯å¤±è´¥ï¼š' + result.info);
                                    }
                                });
                            });

                            // æ·»åŠ æœç´¢æŒ‰é’®äº‹ä»¶
                            document.getElementById('map-search-btn').addEventListener('click', () => {
                                const address = document.getElementById('map-address-input').value.trim();
                                if (address) {
                                    this.showMapLoading(true);
                                    this.geocodeAddress(address);
                                }
                            });
                        })
                        .catch(e => {
                            console.error('åœ°å›¾åŠ è½½å¤±è´¥:', e);
                        });
                    }
                },

                updateLocationMarker(lnglat) {
                    if (this.locationMarker) {
                        this.locationMarker.setMap(null);
                    }

                    this.locationMarker = new AMap.Marker({
                        position: lnglat,
                        map: this.locationMap,
                        icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png"
                    });
                },
                
                geocodeAddress(address) {
                    this.locationGeocoder.getLocation(address, (status, result) => {
                        this.showMapLoading(false);
                        
                        if (status === 'complete' && result.geocodes.length) {
                            const location = result.geocodes[0].location;
                            
                            this.locationMap.setCenter(location);
                            this.locationMap.setZoom(14);
                            
                            this.updateLocationMarker(location);
                            
                            // ä¿å­˜é€‰ä¸­çš„ä½ç½®
                            this.selectedLocation = {
                                lnglat: location,
                                address: result.geocodes[0].formattedAddress,
                                info: null
                            };
                            
                            // æ˜¾ç¤ºå®šä½æˆåŠŸæç¤º
                            setTimeout(() => {
                                alert(`å®šä½æˆåŠŸï¼\nä½ç½®ï¼š${result.geocodes[0].formattedAddress}`);
                            }, 500);
                        } else {
                            alert('å®šä½å¤±è´¥ï¼š' + (result.info || status) + '\nè¯·å°è¯•æ›´å…·ä½“çš„åœ°å€ï¼Œå¦‚"æ²³å—çœå¼€å°å¸‚é¼“æ¥¼åŒº"');
                        }
                    });
                },
                
                showMapLoading(show) {
                    const loading = document.getElementById('map-loading');
                    loading.style.display = show ? 'flex' : 'none';
                },
                
                confirmLocation() {
                    if (!this.selectedLocation) {
                        alert('è¯·å…ˆåœ¨åœ°å›¾ä¸Šé€‰æ‹©ä¸€ä¸ªä½ç½®');
                        return;
                    }
                    
                    // ä¿å­˜ç²¾ç¡®ä½ç½®ä¿¡æ¯ï¼ˆä¼˜åŒ–åï¼‰
                    this.product.exactLocation = {
                        longitude: this.selectedLocation.lnglat.lng,
                        latitude: this.selectedLocation.lnglat.lat,
                        address: this.selectedLocation.address,
                        region: this.selectedLocation.info?.province,
                        city: this.selectedLocation.info?.city,
                        district: this.selectedLocation.info?.district
                    };
                    
                    // å…³é—­åœ°å›¾å¼¹çª—
                    this.closeLocationMap();
                    
                    // æç¤ºç”¨æˆ·å·²é€‰æ‹©ä½ç½®
                    alert(`å·²é€‰æ‹©ä½ç½®ï¼š${this.product.exactLocation.address}`);
                }
            }
        });
    </script>
</body>
</html>